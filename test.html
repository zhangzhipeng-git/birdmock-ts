<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <script type="text/javascript">
      var baseUrl = 'http://localhost:4201';
      var qs = {
        stringify: params => {
          var arr = [];
          Object.keys(params).forEach(k => {
            arr.push(`${k}=${params[k]}`);
          });
          return arr.join('&');
        },
      };

      function log(ctx) {
        switch (ctx.responseType) {
          case 'json':
            console.log(
              `${ctx.responseURL}:`,
              JSON.stringify(ctx.response, null, 2)
            );
            return;
          case 'text':
          default:
            console.log(`${ctx.responseURL}:`, ctx.response);
        }
      }

      function request({
        method = 'GET',
        url,
        headers,
        responseType = 'json',
        params,
      }) {
        var ctx = new XMLHttpRequest();
        var src = `${baseUrl}${url}`;

        if (params) {
          switch (method.toUpperCase()) {
            case 'GET':
            case 'DELETE':
              params = qs.stringify(params);
              src += `?${params}`;
              break;
            case 'POST':
            case 'PUT':
              // json
              if (headers && headers['content-type'].indexOf('json') > -1) {
                params = JSON.stringify(params);
                break;
              }
              // 非 json
              if (!headers) headers = {};
              headers['content-type'] = 'application/x-www-form-urlencoded';
              params = qs.stringify(params);
              break;
          }
        }

        ctx.responseType = responseType;
        ctx.open(method, src, true);

        if (headers) {
          Object.keys(headers).forEach(k => {
            ctx.setRequestHeader(k, headers[k]);
          });
        }

        ctx.send(params);
        return new Promise(resolve => {
          ctx.onload = () => {
            resolve(ctx);
          };
        });
      }

      request({
        url: '/api/example',
        params: { a: 1, b: 2 },
      }).then(log);

      request({
        url: '/ipa/example',
        method: 'POST',
        headers: { 'content-type': 'application/json' },
        params: { c: 3, d: 4 },
      }).then(log);

      request({
        url: '/static/test/bird.svg',
        responseType: 'text',
      })
        .then(ctx => {
          var style = document.createElement('style');
          style.innerText = 'svg {height: 200px;width:200px}';
          document.head.appendChild(style);
          document.body.innerHTML = ctx.responseText;
          return ctx;
        })
        .then(log);

      request({
        url: '/diy/rawResponse',
        responseType: 'text',
      }).then(log);
    </script>
  </body>
</html>
